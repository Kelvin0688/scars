<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#004969" />
  <title>CarScan Pro | Advanced VIN Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #004969;
      --secondary-color: #003040;
      --accent-color: #00a8e8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
    }
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      min-height: 100vh;
    }
    .app-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.2rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-color), rgba(0,168,232,0.5));
    }
    #video-container {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-bottom: 1rem;
      background: #000;
      min-height: 200px;
    }
    #video {
      width: 100%;
      display: block;
    }
    #video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }
    .scan-box {
      width: 85%;
      height: 70px;
      border: 3px solid rgba(0, 168, 232, 0.7);
      border-radius: 8px;
      background-color: rgba(0, 0, 0, 0.3);
      animation: pulse 2s infinite;
      position: relative;
      overflow: hidden;
    }
    .scan-box::after {
      content: '';
      position: absolute;
      top: -50%;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(to bottom, rgba(0,168,232,0.3), transparent);
      animation: scan 3s infinite linear;
    }
    @keyframes pulse {
      0% { border-color: rgba(0, 168, 232, 0.7); }
      50% { border-color: rgba(0, 168, 232, 0.3); }
      100% { border-color: rgba(0, 168, 232, 0.7); }
    }
    @keyframes scan {
      0% { top: -50%; }
      100% { top: 150%; }
    }
    .btn-scan {
      width: 100%;
      margin-top: 10px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      font-weight: 600;
      padding: 14px;
      border-radius: 8px;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .btn-scan:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .btn-details {
      background: linear-gradient(135deg, var(--accent-color), #0095d9);
      border: none;
      font-weight: 600;
      padding: 14px;
      border-radius: 8px;
      width: 100%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .btn-details:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .card {
      border-radius: 12px;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }
    .card-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      padding: 1rem;
    }
    .loading-spinner {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .vin-display {
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      letter-spacing: 1.5px;
      font-weight: bold;
      text-transform: uppercase;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .car-image-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px 8px 0 0;
    }
    .car-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    .car-image-container:hover .car-image {
      transform: scale(1.05);
    }
    .car-image-placeholder {
      width: 100%;
      height: 220px;
      background: linear-gradient(135deg, #e9ecef, #dee2e6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6c757d;
    }
    .car-image-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: white;
      padding: 15px;
    }
    .api-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .spec-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
    }
    .spec-item:last-child {
      border-bottom: none;
    }
    .spec-icon {
      width: 30px;
      text-align: center;
      margin-right: 10px;
      color: var(--primary-color);
    }
    .error-message {
      color: var(--danger-color);
      font-weight: 500;
      padding: 10px;
      background-color: rgba(220,53,69,0.1);
      border-radius: 6px;
      border-left: 4px solid var(--danger-color);
    }
    .success-message {
      color: var(--success-color);
      font-weight: 500;
      padding: 10px;
      background-color: rgba(40,167,69,0.1);
      border-radius: 6px;
      border-left: 4px solid var(--success-color);
    }
    .footer {
      text-align: center;
      padding: 1.5rem;
      color: #6c757d;
      font-size: 0.85rem;
      background-color: #f8f9fa;
      margin-top: 2rem;
    }
    .tab-content {
      padding: 20px;
      background: white;
      border-radius: 0 0 12px 12px;
    }
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
      padding: 0 15px;
    }
    .nav-tabs .nav-link {
      color: #495057;
      font-weight: 500;
      border: none;
      padding: 12px 20px;
      position: relative;
    }
    .nav-tabs .nav-link::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent-color);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
    }
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      font-weight: 600;
      background: transparent;
    }
    .nav-tabs .nav-link.active::after {
      transform: scaleX(1);
    }
    .recall-item {
      padding: 15px;
      border-left: 4px solid var(--danger-color);
      margin-bottom: 15px;
      background-color: #fff8f8;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .recall-item:hover {
      transform: translateX(5px);
    }
    .history-item {
      transition: all 0.3s ease;
      padding: 12px 15px;
    }
    .history-item:hover {
      background-color: #f1f8ff;
      transform: translateX(5px);
    }
    .feature-badge {
      background-color: var(--accent-color);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 8px;
    }
    .spec-badge {
      background-color: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 8px;
    }
    .tech-spec {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .tech-spec-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    .spec-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .no-results {
      text-align: center;
      padding: 30px;
      color: #6c757d;
    }
    .vin-input-container {
      position: relative;
    }
    .vin-input-container::after {
      content: 'VIN';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .gallery-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .gallery-thumbnail {
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .gallery-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .price-badge {
      font-size: 1.1rem;
      padding: 8px 15px;
      border-radius: 20px;
    }
    .price-good {
      background-color: rgba(40,167,69,0.2);
      color: var(--success-color);
    }
    .price-fair {
      background-color: rgba(255,193,7,0.2);
      color: var(--warning-color);
    }
    .price-high {
      background-color: rgba(220,53,69,0.2);
      color: var(--danger-color);
    }
    .history-badge {
      background-color: var(--info-color);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 8px;
    }
    .carousel-control-prev, .carousel-control-next {
      width: 5%;
    }
    @media (max-width: 768px) {
      .spec-grid {
        grid-template-columns: 1fr;
      }
      .car-image, .car-image-placeholder {
        height: 180px;
      }
      .gallery-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h4><i class="fas fa-car"></i> CarScan Pro</h4>
    <small>Advanced Vehicle Identification Scanner</small>
  </div>

  <div class="container my-4">
    <div class="alert alert-primary d-flex align-items-center">
      <i class="fas fa-info-circle me-2"></i>
      <div>Position the VIN barcode or plate within the frame to scan. Works with windshield VINs and door jamb stickers.</div>
    </div>
    
    <div id="video-container">
      <video id="video" autoplay playsinline></video>
      <div id="video-overlay">
        <div class="scan-box"></div>
      </div>
    </div>
    
    <button class="btn btn-primary btn-scan" id="scanButton" onclick="captureVIN()">
      <i class="fas fa-camera me-2"></i> Scan VIN
    </button>
    
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title d-flex align-items-center">
          <i class="fas fa-barcode me-2"></i> VIN Scanner
          <span class="feature-badge">PRO</span>
        </h5>
        <div class="form-group mt-3">
          <label for="vinInput" class="form-label fw-bold">Vehicle Identification Number</label>
          <div class="vin-input-container">
            <input type="text" class="form-control vin-display" id="vinInput" 
                  placeholder="1HGCM82633A123456" maxlength="17"
                  onkeyup="this.value = this.value.toUpperCase()" />
          </div>
          <div id="vinError" class="error-message mt-2" style="display: none;"></div>
          <div id="vinSuccess" class="success-message mt-2" style="display: none;"></div>
          <button class="btn btn-details mt-3" id="detailsButton" onclick="getCarDetails()">
            <i class="fas fa-car-side me-2"></i> Get Full Vehicle Report
          </button>
        </div>
      </div>
    </div>

    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 fw-bold">Fetching vehicle details...</p>
    </div>

    <div id="carDetails" class="mt-4"></div>
    
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-history me-2"></i> Scan History</span>
        <button class="btn btn-sm btn-outline-light" onclick="clearHistory()">
          <i class="fas fa-trash-alt me-1"></i> Clear
        </button>
      </div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush" id="scanHistory">
          <li class="list-group-item text-muted py-3">No scan history yet</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="footer">
    <p class="mb-1">CarScan Pro &copy; 2023 | Professional Vehicle Identification System</p>
    <small class="text-muted">Uses NHTSA VIN Decoder API, Recall API, Vehicle History API, and Market Data API</small>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
    // DOM Elements
    const video = document.getElementById("video");
    const vinInput = document.getElementById("vinInput");
    const vinError = document.getElementById("vinError");
    const vinSuccess = document.getElementById("vinSuccess");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const carDetails = document.getElementById("carDetails");
    const scanHistory = document.getElementById("scanHistory");
    const scanButton = document.getElementById("scanButton");
    const detailsButton = document.getElementById("detailsButton");

    // Configuration
    const config = {
      enableOCR: true,
      enableNHTSA: true,
      enableRecalls: true,
      enableImages: true,
      enableHistory: true,
      enableMarketData: true,
      maxHistory: 10,
      scanTimeout: 10000, // 10 seconds
      // API keys would be stored securely in production
      apiKeys: {
        nhtsa: 'DEMO_KEY', // Free tier
        edmunds: 'DEMO_KEY', // Replace with actual key
        carfax: 'DEMO_KEY', // Replace with actual key
        pixabay: '38012803-2a8b7b5b5b1b9b9b9b9b9b9b9' // Free demo key
      }
    };

    // Store scan history in localStorage
    let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
    updateHistoryList();

    // Camera Initialization (fixed mirroring issue)
    async function initCamera() {
      try {
        const constraints = {
          video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            resolve(true);
          };
        });
      } catch (err) {
        console.error("Camera error:", err);
        showError("Camera access denied. Please enable camera permissions to use the scanner.");
        scanButton.disabled = true;
        return false;
      }
    }

    // Initialize camera on page load
    document.addEventListener('DOMContentLoaded', async () => {
      const cameraReady = await initCamera();
      if (!cameraReady) {
        document.getElementById('video-overlay').style.display = 'none';
      }
    });

    // Enhanced VIN Validation
    function isValidVIN(vin) {
      if (!vin || typeof vin !== 'string') return false;
      return /^[A-HJ-NPR-Z0-9]{17}$/.test(vin);
    }

    // Enhanced OCR Scanning with Timeout
    async function captureVIN() {
      if (!video.srcObject) {
        showError("Camera not available. Please enable camera access.");
        return;
      }
      
      try {
        showLoading("Scanning VIN...");
        scanButton.disabled = true;
        
        // Set timeout for scanning
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Scan timeout')), config.scanTimeout);
        });
        
        const scanPromise = (async () => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          
          // Capture frame (no mirroring needed for back camera)
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          // Preprocess image for better OCR
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          // Convert to grayscale and enhance contrast
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            // High contrast binarization
            data[i] = data[i + 1] = data[i + 2] = avg < 160 ? 0 : 255;
          }
          ctx.putImageData(imageData, 0, 0);
          
          // Use Tesseract.js with optimized settings
          const { data: { text } } = await Tesseract.recognize(
            canvas.toDataURL('image/jpeg', 0.9),
            'eng',
            { 
              logger: m => console.debug(m),
              tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
              tessedit_pageseg_mode: 7, // Treat image as single text line
              preserve_interword_spaces: 0
            }
          );
          
          // Clean and extract potential VIN
          const cleanedText = text.replace(/\s/g, "").toUpperCase();
          const vinMatches = cleanedText.match(/[A-HJ-NPR-Z0-9]{17}/g);
          
          if (vinMatches && vinMatches.length > 0) {
            // Find the most likely VIN (could be multiple matches)
            const validVins = vinMatches.filter(vin => isValidVIN(vin));
            if (validVins.length > 0) {
              return validVins[0]; // Return first valid VIN
            }
          }
          throw new Error("No valid VIN detected");
        })();
        
        const vin = await Promise.race([scanPromise, timeoutPromise]);
        vinInput.value = vin;
        showSuccess("VIN successfully scanned!");
        addToHistory(vin);
        
      } catch (err) {
        console.error("Scan error:", err);
        const errorMsg = err.message.includes('timeout') 
          ? "Scanning took too long. Try better lighting or enter manually." 
          : "Couldn't detect a valid VIN. Try again or enter manually.";
        showError(errorMsg);
      } finally {
        hideLoading();
        scanButton.disabled = false;
      }
    }

    // Main Function to Get Vehicle Details
    async function getCarDetails() {
      const vin = vinInput.value.trim();
      
      if (!isValidVIN(vin)) {
        showError("Please enter a valid 17-character VIN (excludes I, O, Q)");
        return;
      }
      
      try {
        showLoading("Generating full vehicle report...");
        detailsButton.disabled = true;
        carDetails.innerHTML = "";
        
        // Fetch all data in parallel
        const [nhtsaData, recalls, marketData, vehicleHistory, images] = await Promise.all([
          config.enableNHTSA ? fetchNHTSAData(vin) : Promise.resolve(null),
          config.enableRecalls ? fetchRecallInfo(vin) : Promise.resolve([]),
          config.enableMarketData ? fetchMarketData(vin) : Promise.resolve(null),
          config.enableHistory ? fetchVehicleHistory(vin) : Promise.resolve(null),
          config.enableImages ? fetchVehicleImages(vin) : Promise.resolve([])
        ]);
        
        // Process data
        const vehicle = nhtsaData ? parseNHTSAData(nhtsaData) : {};
        if (marketData) Object.assign(vehicle, marketData);
        if (vehicleHistory) vehicle.history = vehicleHistory;
        
        // Display all data
        displayVehicleDetails(vehicle, recalls, images);
        addToHistory(vin);
        
      } catch (err) {
        console.error("API error:", err);
        showError("Failed to fetch vehicle details. The VIN may be invalid or API services are unavailable.");
      } finally {
        hideLoading();
        detailsButton.disabled = false;
      }
    }

    // NHTSA API Fetch
    async function fetchNHTSAData(vin) {
      try {
        const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${vin}?format=json`);
        if (!response.ok) throw new Error("NHTSA API failed");
        const data = await response.json();
        return data.Results && data.Results[0] ? data.Results[0] : null;
      } catch (e) {
        console.error("NHTSA API error:", e);
        return null;
      }
    }

    // Enhanced Vehicle Data Fetch (mock - replace with actual API)
    async function fetchMarketData(vin) {
      // In a real app, this would call a commercial API like Edmunds or your own database
      // This is a mock implementation with sample data
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            marketValue: "$24,500 - $28,300",
            fuelEfficiency: "24 city / 32 highway",
            safetyRating: "5 stars (NHTSA)",
            features: ["Bluetooth", "Backup Camera", "Apple CarPlay", "Heated Seats"],
            engineSpecs: "2.0L Turbocharged 4-cylinder, 252hp @ 5500rpm, 273 lb-ft @ 1800rpm",
            transmissionSpecs: "8-speed automatic with manual shift mode",
            drivetrain: "Front-wheel drive with traction control",
            dimensions: "192.2 in. length, 73.3 in. width, 57.5 in. height",
            weight: "3,354 lbs",
            warranty: "3 yr/36,000 mi basic, 5 yr/60,000 mi powertrain",
            priceRating: "good" // good/fair/high
          });
        }, 800);
      });
    }

    // Vehicle History Fetch (mock - replace with actual API)
    async function fetchVehicleHistory(vin) {
      // In a real app, this would call Carfax or similar service
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            ownerCount: 2,
            serviceRecords: 12,
            accidentReports: 1,
            lastOdometer: 45230,
            titleStatus: "Clean",
            reportedIssues: ["Minor accident reported in 2021 (rear bumper)"]
          });
        }, 1000);
      });
    }

    // Vehicle Images Fetch (using multiple sources)
    async function fetchVehicleImages(vin) {
      if (!config.enableImages) return [];
      
      try {
        // First try to get images based on VIN
        let images = await fetchImagesByVIN(vin);
        
        // If no results, try with make/model/year if we have that data
        if (images.length === 0) {
          const nhtsaData = await fetchNHTSAData(vin);
          if (nhtsaData) {
            const vehicle = parseNHTSAData(nhtsaData);
            if (vehicle.make && vehicle.model && vehicle.year) {
              images = await fetchImagesByMakeModel(vehicle.make, vehicle.model, vehicle.year);
            }
          }
        }
        
        return images;
      } catch (e) {
        console.error("Image fetch error:", e);
        return [];
      }
    }

    // Fetch images by VIN (mock - replace with actual API)
    async function fetchImagesByVIN(vin) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve([
            "https://source.unsplash.com/random/600x400/?car",
            "https://source.unsplash.com/random/600x400/?vehicle",
            "https://source.unsplash.com/random/600x400/?automobile"
          ]);
        }, 500);
      });
    }

    // Fetch images by make/model/year (mock - replace with actual API)
    async function fetchImagesByMakeModel(make, model, year) {
      const query = `${make}+${model}+${year}+car`.replace(/\s+/g, '+');
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve([
            `https://source.unsplash.com/random/600x400/?${query}`,
            `https://source.unsplash.com/random/600x400/?${make}+${model}`,
            `https://source.unsplash.com/random/600x400/?${make}+car`
          ]);
        }, 500);
      });
    }

    // Recall Information Fetch
    async function fetchRecallInfo(vin) {
      try {
        const response = await fetch(`https://api.nhtsa.gov/recalls/recallsByVehicle?vin=${vin}`);
        if (!response.ok) throw new Error("Recall API failed");
        const data = await response.json();
        return data.results || [];
      } catch (e) {
        console.error("Recall API error:", e);
        return [];
      }
    }

    // Enhanced NHTSA Data Parser
    function parseNHTSAData(data) {
      const getValue = (variable) => {
        const value = data[variable];
        return value && value !== "" && value !== "Not Applicable" ? value : "â€”";
      };
      
      return {
        // Basic Info
        make: getValue("Make"),
        model: getValue("Model"),
        year: getValue("ModelYear"),
        trim: getValue("Trim"),
        series: getValue("Series"),
        body: getValue("BodyClass"),
        doors: getValue("Doors"),
        
        // Engine & Performance
        engine: getValue("EngineModel"),
        cylinders: getValue("EngineNumberOfCylinders"),
        displacement: getValue("DisplacementL"),
        fuel: getValue("FuelTypePrimary"),
        fuelCapacity: getValue("FuelCapacity"),
        fuelDelivery: getValue("FuelDeliveryFuelInjectionType"),
        horsepower: getValue("EngineHP"),
        torque: getValue("EngineKW"),
        
        // Transmission & Drivetrain
        transmission: getValue("TransmissionStyle"),
        transmissionSpeeds: getValue("TransmissionSpeeds"),
        drive: getValue("DriveType"),
        
        // Dimensions
        wheelbase: getValue("WheelBase"),
        length: getValue("OverallLength"),
        width: getValue("OverallWidth"),
        height: getValue("OverallHeight"),
        seating: getValue("Seats"),
        
        // Manufacturer Info
        manufacturer: getValue("Manufacturer"),
        plant: getValue("PlantCity") + ", " + getValue("PlantCountry"),
        plantCode: getValue("PlantCompanyName"),
        
        // Safety
        airbags: getValue("AirBagLocations"),
        brakeSystem: getValue("BrakeSystemType"),
        safetySystems: getValue("OtherSafetySystems"),
        
        // Additional
        vin: getValue("VIN"),
        suggestedTirePressure: getValue("TirePressure"),
        GVWR: getValue("GVWR"),
        standardFeatures: getValue("OtherEngineInfo")
      };
    }

    // Display Vehicle Details with Enhanced UI
    function displayVehicleDetails(vehicle, recalls, images = []) {
      // Format specifications into categories
      const specs = {
        overview: [
          { label: "Make", value: vehicle.make, icon: "industry" },
          { label: "Model", value: vehicle.model, icon: "car-alt" },
          { label: "Year", value: vehicle.year, icon: "calendar-alt" },
          { label: "Trim", value: vehicle.trim, icon: "tag" },
          { label: "Body Style", value: vehicle.body, icon: "car-side" },
          { label: "Manufacturer", value: vehicle.manufacturer, icon: "building" }
        ],
        engine: [
          { label: "Engine", value: vehicle.engine, icon: "cogs" },
          { label: "Cylinders", value: vehicle.cylinders, icon: "tachometer-alt" },
          { label: "Displacement", value: vehicle.displacement, icon: "gas-pump" },
          { label: "Horsepower", value: vehicle.horsepower, icon: "bolt" },
          { label: "Fuel Type", value: vehicle.fuel, icon: "gas-pump" },
          { label: "Fuel System", value: vehicle.fuelDelivery, icon: "oil-can" }
        ],
        transmission: [
          { label: "Transmission", value: vehicle.transmission, icon: "cog" },
          { label: "Speeds", value: vehicle.transmissionSpeeds, icon: "tachometer-alt" },
          { label: "Drive Type", value: vehicle.drive, icon: "car" }
        ],
        dimensions: [
          { label: "Length", value: vehicle.length, icon: "ruler-horizontal" },
          { label: "Width", value: vehicle.width, icon: "ruler-vertical" },
          { label: "Height", value: vehicle.height, icon: "ruler" },
          { label: "Wheelbase", value: vehicle.wheelbase, icon: "car-side" },
          { label: "Seating", value: vehicle.seating, icon: "chair" },
          { label: "Doors", value: vehicle.doors, icon: "door-open" }
        ],
        features: vehicle.features ? vehicle.features.map(f => ({
          label: f, value: "", icon: "check-circle"
        })) : []
      };

      // Determine price rating class
      const priceRatingClass = vehicle.priceRating 
        ? `price-${vehicle.priceRating}` 
        : 'price-fair';

      carDetails.innerHTML = `
        <div class="card">
          <!-- Image Carousel -->
          <div id="vehicleCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              ${images.length > 0 ? 
                images.map((img, index) => `
                  <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <div class="car-image-container">
                      <img src="${img}" class="d-block w-100 car-image" alt="${vehicle.make} ${vehicle.model}">
                      <div class="car-image-overlay">
                        <h4>${vehicle.make} ${vehicle.model}</h4>
                        <h5>${vehicle.year} ${vehicle.trim || ''}</h5>
                      </div>
                    </div>
                  </div>
                `).join('') : `
                <div class="carousel-item active">
                  <div class="car-image-placeholder">
                    <i class="fas fa-car fa-3x mb-2"></i>
                    <div>Image not available</div>
                  </div>
                </div>
              `}
            </div>
            ${images.length > 1 ? `
              <button class="carousel-control-prev" type="button" data-bs-target="#vehicleCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#vehicleCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            ` : ''}
          </div>
          
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h3 class="card-title mb-1">${vehicle.make} ${vehicle.model}</h3>
                <h4 class="card-subtitle text-muted">${vehicle.year} ${vehicle.trim || ''}</h4>
              </div>
              <div class="text-end">
                <div class="price-badge ${priceRatingClass}">${vehicle.marketValue || 'Value N/A'}</div>
                <small class="text-muted">Market Range</small>
              </div>
            </div>
            
            <ul class="nav nav-tabs" id="carTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                  <i class="fas fa-info-circle me-1"></i> Overview
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab">
                  <i class="fas fa-cogs me-1"></i> Specs
                </button>
              </li>
              ${images.length > 0 ? `
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button" role="tab">
                  <i class="fas fa-images me-1"></i> Gallery
                </button>
              </li>` : ''}
              ${vehicle.history ? `
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                  <i class="fas fa-history me-1"></i> History
                </button>
              </li>` : ''}
              ${recalls.length > 0 ? `
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="recalls-tab" data-bs-toggle="tab" data-bs-target="#recalls" type="button" role="tab">
                  <i class="fas fa-exclamation-triangle me-1"></i> Recalls <span class="badge bg-danger">${recalls.length}</span>
                </button>
              </li>` : ''}
            </ul>
            
            <div class="tab-content" id="carTabsContent">
              <!-- Overview Tab -->
              <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="row mt-3">
                  <div class="col-md-6">
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-car me-2"></i> Vehicle Overview
                      </div>
                      <div class="spec-grid">
                        ${specs.overview.map(item => `
                          <div class="spec-item">
                            <div class="spec-icon"><i class="fas fa-${item.icon}"></i></div>
                            <div>
                              <div class="fw-bold">${item.label}</div>
                              <div>${item.value}</div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    
                    ${vehicle.engineSpecs ? `
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-cogs me-2"></i> Engine Specifications
                      </div>
                      <p>${vehicle.engineSpecs}</p>
                    </div>` : ''}
                  </div>
                  
                  <div class="col-md-6">
                    ${vehicle.safetyRating ? `
                    <div class="tech-spec">
                      <div class="tech-spec-title text-danger">
                        <i class="fas fa-shield-alt me-2"></i> Safety Rating
                      </div>
                      <div class="d-flex align-items-center">
                        <div class="display-4 me-3">${vehicle.safetyRating.split(' ')[0]}</div>
                        <div>${vehicle.safetyRating}</div>
                      </div>
                    </div>` : ''}
                    
                    ${vehicle.fuelEfficiency ? `
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-gas-pump me-2"></i> Fuel Efficiency
                      </div>
                      <div class="d-flex align-items-center">
                        <div class="display-4 me-3">
                          <i class="fas fa-leaf text-success"></i>
                        </div>
                        <div>${vehicle.fuelEfficiency}</div>
                      </div>
                    </div>` : ''}
                    
                    ${vehicle.warranty ? `
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-certificate me-2"></i> Warranty
                      </div>
                      <p>${vehicle.warranty}</p>
                    </div>` : ''}
                  </div>
                </div>
              </div>
              
              <!-- Specifications Tab -->
              <div class="tab-pane fade" id="specs" role="tabpanel">
                <div class="row mt-3">
                  <div class="col-md-6">
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-cogs me-2"></i> Engine & Performance
                      </div>
                      <div class="spec-grid">
                        ${specs.engine.map(item => `
                          <div class="spec-item">
                            <div class="spec-icon"><i class="fas fa-${item.icon}"></i></div>
                            <div>
                              <div class="fw-bold">${item.label}</div>
                              <div>${item.value}</div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-tachometer-alt me-2"></i> Transmission & Drivetrain
                      </div>
                      <div class="spec-grid">
                        ${specs.transmission.map(item => `
                          <div class="spec-item">
                            <div class="spec-icon"><i class="fas fa-${item.icon}"></i></div>
                            <div>
                              <div class="fw-bold">${item.label}</div>
                              <div>${item.value}</div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-ruler-combined me-2"></i> Dimensions
                      </div>
                      <div class="spec-grid">
                        ${specs.dimensions.map(item => `
                          <div class="spec-item">
                            <div class="spec-icon"><i class="fas fa-${item.icon}"></i></div>
                            <div>
                              <div class="fw-bold">${item.label}</div>
                              <div>${item.value}</div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Gallery Tab -->
              ${images.length > 0 ? `
              <div class="tab-pane fade" id="gallery" role="tabpanel">
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-images me-2"></i> Vehicle Gallery
                      </div>
                      <div class="gallery-container">
                        ${images.map((img, index) => `
                          <img src="${img}" class="gallery-thumbnail" 
                               onclick="openImageModal('${img}', ${index})"
                               alt="${vehicle.make} ${vehicle.model} ${index + 1}">
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- History Tab -->
              ${vehicle.history ? `
              <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="tech-spec">
                      <div class="tech-spec-title">
                        <i class="fas fa-history me-2"></i> Vehicle History Report
                      </div>
                      
                      <div class="row mb-4">
                        <div class="col-md-4">
                          <div class="text-center p-3 border rounded">
                            <div class="display-5">${vehicle.history.ownerCount}</div>
                            <div class="text-muted">Owners</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-center p-3 border rounded">
                            <div class="display-5">${vehicle.history.serviceRecords}</div>
                            <div class="text-muted">Service Records</div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="text-center p-3 border rounded">
                            <div class="display-5">${vehicle.history.accidentReports}</div>
                            <div class="text-muted">Accidents</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="alert ${vehicle.history.accidentReports > 0 ? 'alert-warning' : 'alert-success'}">
                        <i class="fas fa-${vehicle.history.accidentReports > 0 ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                        Title Status: <strong>${vehicle.history.titleStatus}</strong>
                        ${vehicle.history.accidentReports > 0 ? 'with accident history' : 'with no accidents reported'}
                      </div>
                      
                      ${vehicle.history.reportedIssues && vehicle.history.reportedIssues.length > 0 ? `
                      <div class="mt-3">
                        <h5 class="mb-3"><i class="fas fa-exclamation-circle me-2"></i> Reported Issues</h5>
                        <ul class="list-group">
                          ${vehicle.history.reportedIssues.map(issue => `
                            <li class="list-group-item">${issue}</li>
                          `).join('')}
                        </ul>
                      </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Recalls Tab -->
              ${recalls.length > 0 ? `
              <div class="tab-pane fade" id="recalls" role="tabpanel">
                <div class="alert alert-danger mt-2">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  This vehicle has ${recalls.length} open recall${recalls.length > 1 ? 's' : ''}. Contact your dealer for repairs.
                </div>
                
                ${recalls.map(recall => `
                  <div class="recall-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <strong class="mb-1">${recall.nhtsaCampaignNumber}</strong>
                      <small class="text-muted">${new Date(recall.reportReceivedDate).toLocaleDateString()}</small>
                    </div>
                    <h6 class="mb-2">${recall.component}</h6>
                    <p class="mb-2">${recall.summary}</p>
                    <div class="d-flex justify-content-between">
                      <small class="text-muted">Manufacturer: ${recall.manufacturer}</small>
                      <a href="${recall.url || '#'}" target="_blank" class="btn btn-sm btn-outline-danger">
                        Details <i class="fas fa-external-link-alt ms-1"></i>
                      </a>
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
          </div>
        </div>
        
        <!-- Image Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${vehicle.make} ${vehicle.model}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" style="max-height: 70vh;">
              </div>
              <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" id="prevImage">
                  <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="imageCounter"></span>
                <button type="button" class="btn btn-secondary" id="nextImage">
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Initialize Bootstrap components
      const tabEls = document.querySelectorAll('#carTabs button');
      tabEls.forEach(tabEl => {
        new bootstrap.Tab(tabEl);
      });
      
      if (images.length > 1) {
        new bootstrap.Carousel(document.getElementById('vehicleCarousel'));
      }
      
      // Initialize image modal functionality
      if (images.length > 0) {
        window.openImageModal = (src, index) => {
          const modal = new bootstrap.Modal(document.getElementById('imageModal'));
          const modalImg = document.getElementById('modalImage');
          const imageCounter = document.getElementById('imageCounter');
          
          modalImg.src = src;
          imageCounter.textContent = `${index + 1} of ${images.length}`;
          
          document.getElementById('prevImage').onclick = () => {
            const newIndex = (index - 1 + images.length) % images.length;
            modalImg.src = images[newIndex];
            imageCounter.textContent = `${newIndex + 1} of ${images.length}`;
            index = newIndex;
          };
          
          document.getElementById('nextImage').onclick = () => {
            const newIndex = (index + 1) % images.length;
            modalImg.src = images[newIndex];
            imageCounter.textContent = `${newIndex + 1} of ${images.length}`;
            index = newIndex;
          };
          
          modal.show();
        };
      }
    }

    // History Management
    function addToHistory(vin) {
      if (!history.includes(vin)) {
        history.unshift(vin);
        if (history.length > config.maxHistory) history.pop();
        localStorage.setItem('scanHistory', JSON.stringify(history));
        updateHistoryList();
      }
    }

    function updateHistoryList() {
      if (history.length === 0) {
        scanHistory.innerHTML = '<li class="list-group-item text-muted py-3">No scan history yet</li>';
        return;
      }
      
      scanHistory.innerHTML = history.map(vin => `
        <li class="list-group-item history-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="vin-display">${vin}</span>
              <small class="text-muted d-block mt-1">${new Date().toLocaleString()}</small>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="useHistoryVIN('${vin}')">
                <i class="fas fa-search"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeFromHistory('${vin}')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </li>
      `).join('');
    }

    function clearHistory() {
      if (history.length === 0) return;
      
      if (confirm("Clear all scan history?")) {
        history = [];
        localStorage.removeItem('scanHistory');
        updateHistoryList();
      }
    }

    function removeFromHistory(vin) {
      history = history.filter(v => v !== vin);
      localStorage.setItem('scanHistory', JSON.stringify(history));
      updateHistoryList();
    }

    function useHistoryVIN(vin) {
      vinInput.value = vin;
      showSuccess("VIN loaded from history");
      setTimeout(() => {
        getCarDetails();
      }, 500);
    }

    // UI Helpers
    function showLoading(message) {
      loadingSpinner.style.display = 'block';
      loadingSpinner.querySelector('p').textContent = message;
      carDetails.innerHTML = '';
    }

    function hideLoading() {
      loadingSpinner.style.display = 'none';
    }

    function showError(message) {
      vinError.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${message}`;
      vinError.style.display = 'block';
      vinSuccess.style.display = 'none';
    }

    function showSuccess(message) {
      vinSuccess.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${message}`;
      vinSuccess.style.display = 'block';
      vinError.style.display = 'none';
    }

    // Event Listeners
    vinInput.addEventListener('input', (e) => {
      const value = e.target.value.toUpperCase();
      e.target.value = value.replace(/[^A-HJ-NPR-Z0-9]/g, '');
      
      if (e.target.value.length === 17) {
        showSuccess("Valid VIN format detected");
      } else {
        vinSuccess.style.display = 'none';
      }
    });

    // Allow Enter key to trigger details fetch
    vinInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        getCarDetails();
      }
    });
  </script>
</body>
</html>